# Тестовое задание osmi-it

_Автор: samokander_

## Задание

1. Переписать с Solidity 0.6.6 → 0.8.20+.

2. Убрать SafeMath, обновить OpenZeppelin, адаптировать интерфейсы.

3. Сохранить всю логику (флешлон Aave, свопы DEX, whitelist, profit withdraw).

4. Добавить: custom errors, access control, nonReentrant, Pausable, safe approve.

5. Оптимизация: immutable, constant, unchecked loops.

6. Документация (NatSpec), читаемые имена, комментарии.

## Установка

1. Склонирйте репозиторий

```bash
git clone https://github.com/samokander/osmi-it-test-task.git
cd osmi-it-test-task
```

2. Установите [Foundry](https://getfoundry.sh/)

```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
forge --version
```

3. Установите зависимости

```bash
forge install
```

4. Скомпилируйте контракт

```bash
forge compile
```

5. Сгенерируйте и запустите документацию

```bash
forge doc --serve --open
```

6. Создайте .env файл

```bash
cp .env.example .env
```

7. Запустите скрипты развертывания

```bash
source .env
forge script script/FlashArbMainnetReady.sol --fork-url "$MAINNET_RPC_URL"
```

## Структура

- `src/`: Исходный код смарт-контрактов.
  - `new/`: Обновленный контракт на версии 0.8.29.
  - `legacy/`: Исходный legacy контракт.
- `script/`: Скрипты для развертывания и взаимодействия с контрактами.
- `README.md`: Документация проекта.
- `.env`: Файл окружения с переменными

## Лог

Миграцию контракта будем производить на последнюю досутпную версию компилятора 0.8.29.

Legacy контракт не компилируется из за ошибок Stack too deep. Эти ошибки в самом легаси контракте решено не исправлять, они пропадут при миграции. Соответственно компилятор настроен на рабочую директорию src/new, чтобы не ловить ошибки при компиляции обновленных контрактов.

Так как контракт должен работать с hardcoded адресами, интерфейсы оставляем в текущем виде. Отрефакторим для удобства.

Обновим OpenZeppelin до последней версии 5.4.0, уберем `SafeMath`, так как в версии Solidity 0.8+ есть встроенная защита от overflow.

Воспользуемся новыми возможностями Solidity 0.8.24+ и последними обновлениями Ethereum, и `ReentrancyGuard` заменим на `ReentrancyGuardTransient`, что позволит сэкономить ~2000 газа за вызов.

Для корректной компиляции контракта уберем неиспользуемые переменные. Добавим оптимизатор с высокими значениями runs, так как контракт предполагается использовать часто.

После успешной компиляции контракта можно присутпать к оптимизациям: блоки unchecked, кастомные ошибки, убрать лишние проверки.

По заданию необходимо добавить custom errors, хотя для обратной совместимости с ABI legacy контракта я бы рекомендовал оставить require с revert string.
